options:
  logging: CLOUD_LOGGING_ONLY

substitutions:
  _REGION: europe-west2
  _REPO: innerpeace
  _IMAGE: innerpeace-api

steps:
- name: gcr.io/cloud-builders/gcloud
  args: ['auth','configure-docker','${_REGION}-docker.pkg.dev','-q']

- name: gcr.io/cloud-builders/docker
  args: ['build','-t','${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO}/${_IMAGE}:${SHORT_SHA}','.']

- name: gcr.io/cloud-builders/docker
  args: ['push','${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO}/${_IMAGE}:${SHORT_SHA}']

# Resolve digest, then deploy BY DIGEST (no tag drift)
- name: gcr.io/cloud-builders/gcloud
  entrypoint: bash
  args:
    - -lc
    - |
      IMG="${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO}/${_IMAGE}"
      DIGEST="$(gcloud artifacts docker tags list "$IMG" --filter="tag:${SHORT_SHA}" --format='value(digest)')"
      gcloud run deploy ${_IMAGE} \
        --region=${_REGION} \
        --image="${IMG}@${DIGEST}" \
        --service-account="run-innerpeace-sa@$PROJECT_ID.iam.gserviceaccount.com" \
        --min-instances=1 --max-instances=20 --concurrency=80 --timeout=240 \
        --set-secrets="CALENDAR_ID=CALENDAR_ID:latest,GOOGLE_SERVICE_ACCOUNT_EMAIL=GOOGLE_SERVICE_ACCOUNT_EMAIL:latest,GOOGLE_DELEGATED_USER=GOOGLE_DELEGATED_USER:latest,USE_MEET=USE_MEET:latest"
