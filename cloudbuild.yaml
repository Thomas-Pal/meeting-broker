substitutions:
  _REGION: europe-west2
  _REPO: innerpeace
  _SERVICE: meeting-broker
  _IMAGE: ${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO}/${_SERVICE}
  _RUNTIME_SA: ${_SERVICE}-runner@${PROJECT_ID}.iam.gserviceaccount.com

steps:
  - name: gcr.io/cloud-builders/docker
    args: ["build","-t","${_IMAGE}:$SHORT_SHA","server"]

  - name: gcr.io/cloud-builders/docker
    args: ["push","${_IMAGE}:$SHORT_SHA"]

  - name: gcr.io/cloud-builders/gcloud
    args:
      [
        "run","deploy","${_SERVICE}",
        "--region","${_REGION}",
        "--image","${_IMAGE}:$SHORT_SHA",
        "--service-account","${_RUNTIME_SA}",
        "--allow-unauthenticated",
        "--set-env-vars","CALENDAR_ID=REPLACE_CALENDAR_ID",
        "--set-env-vars","USE_MEET=auto",
        "--set-env-vars","GOOGLE_SERVICE_ACCOUNT_EMAIL=REPLACE_SA_EMAIL",
        "--set-env-vars","GOOGLE_DELEGATED_USER=REPLACE_USER_EMAIL"
      ]

images:
  - "${_IMAGE}:$SHORT_SHA"
